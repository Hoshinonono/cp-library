name: verify

on: push

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
      with:
        submodules: false 

    - name: Set up Python
      uses: actions/setup-python@v1
    
    - name: Install ac-library
      run: |
          git clone --no-checkout https://github.com/atcoder/ac-library.git
          cd ac-library
          git sparse-checkout init --cone
          git sparse-checkout set atcoder
          git checkout
          mv atcoder ../
          cd ../

    - name: Install dependencies
      run: pip3 install -U online-judge-verify-helper
      
    - name: Run tests
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          YUKICODER_TOKEN: ${{ secrets.YUKICODER_TOKEN }}
          GH_PAT: ${{ secrets.GH_PAT }}
      run: oj-verify all

  clean-index:
    needs: verify         # ← verify が完了してから実行される
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Remove ac-library from index
        run: |
          git checkout gh-pages
          yq eval '
            del(.data.libraryCategories[] | select(.name == "ac-library")) |
            del(.data.libraryCategories[] | select(.name == "atcoder"))
          ' index.md > index_tmp.md
          mv index_tmp.md index.md

      - name: Commit and push changes
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add index.md
          git diff --cached --exit-code || (git commit -m "Remove ac-library and atcoder sections" && git push)
